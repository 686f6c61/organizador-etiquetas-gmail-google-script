<script>
  /**
   * @file Script.html
   * @description Codigo JavaScript del lado del cliente con proteccion XSS,
   *              validacion, feedback visual y generacion dinamica de controles.
   *
   *              Politica de seguridad:
   *              - textContent para todo dato que provenga del servidor o del usuario.
   *              - createElement/appendChild para construir DOM de forma segura.
   *              - escapeHtml() como ultima linea de defensa cuando se necesita
   *                formato HTML controlado (p.ej. saltos de linea en mensajes).
   *
   * @author 686f6c61
   * @version 0.5
   * @date 2025-11-17
   */

  // --- Variables globales ---
  var config = {};
  var statsData = {
    totalProcessed: 0,
    totalLabeled: 0,
    domainStats: {},
    lastRun: null
  };

  // --- Utilidades de seguridad ---

  /**
   * @description Escapa caracteres HTML peligrosos para prevenir XSS.
   * @param {string} text - Texto sin escapar
   * @returns {string} Texto con entidades HTML neutralizadas
   */
  function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(String(text)));
    return div.textContent;
  }

  /**
   * @description Construye un elemento de estado con texto formateado de forma segura.
   *              Usa DOM methods en vez de innerHTML para inyectar contenido.
   * @param {string} elementId - ID del contenedor de estado
   * @param {Array<string|{tag:string, text:string, style?:string}>} parts - Partes del mensaje
   * @param {string} type - Tipo: 'success', 'error', 'info'
   */
  function showStatusSafe(elementId, parts, type) {
    var element = document.getElementById(elementId);
    while (element.firstChild) element.removeChild(element.firstChild);

    parts.forEach(function(part) {
      if (typeof part === 'string') {
        element.appendChild(document.createTextNode(part));
      } else if (part.tag === 'br') {
        element.appendChild(document.createElement('br'));
      } else if (part.tag === 'spinner') {
        var spinner = document.createElement('div');
        spinner.className = 'spinner';
        element.appendChild(spinner);
      } else {
        var el = document.createElement(part.tag || 'span');
        el.textContent = part.text || '';
        if (part.style) el.style.cssText = part.style;
        if (part.cls) el.className = part.cls;
        element.appendChild(el);
      }
    });

    element.className = 'status ' + type;
    element.style.display = 'block';
  }

  /**
   * @description Atajo para mensajes simples de una linea.
   * @param {string} elementId
   * @param {string} message - Texto plano (se inserta con textContent)
   * @param {string} type
   */
  function showStatus(elementId, message, type) {
    var element = document.getElementById(elementId);
    while (element.firstChild) element.removeChild(element.firstChild);
    element.appendChild(document.createTextNode(message));
    element.className = 'status ' + type;
    element.style.display = 'block';
  }

  function hideStatus(elementId) {
    var element = document.getElementById(elementId);
    element.style.display = 'none';
  }

  // --- Inicializacion ---

  document.addEventListener('DOMContentLoaded', function() {
    generateProcessHourOptions();
    bindEventListeners();
    loadConfig();
    loadStats();
  });

  function generateProcessHourOptions() {
    var select = document.getElementById('processHour');
    for (var h = 0; h < 24; h++) {
      var opt = document.createElement('option');
      opt.value = h;
      opt.textContent = String(h).padStart(2, '0') + ':00';
      select.appendChild(opt);
    }
  }

  function bindEventListeners() {
    document.getElementById('processButton').addEventListener('click', processEmails);
    document.getElementById('addDomainButton').addEventListener('click', addDomain);
    document.getElementById('saveButton').addEventListener('click', saveConfig);
    document.getElementById('exportButton').addEventListener('click', exportStats);
    document.getElementById('clearStatsButton').addEventListener('click', clearStats);

    document.getElementById('newDomain').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addDomain();
      }
    });
  }

  // --- Carga de datos ---

  function loadConfig() {
    showStatus('processStatus', 'Cargando configuracion...', 'info');
    google.script.run
      .withSuccessHandler(updateUI)
      .withFailureHandler(handleError)
      .getConfig();
  }

  function loadStats() {
    google.script.run
      .withSuccessHandler(updateStatsUI)
      .withFailureHandler(handleError)
      .getStats();
  }

  // --- Actualizacion de la UI ---

  function updateUI(loadedConfig) {
    config = loadedConfig;

    document.getElementById('maxEmails').value = config.maxEmails;

    var daysBackSelect = document.getElementById('daysBack');
    daysBackSelect.value = config.daysBack === -1 ? '-1' : config.daysBack;

    document.getElementById('autoProcess').checked = config.autoProcess;
    document.getElementById('processHour').value = config.processHour;
    document.getElementById('avoidSubdomains').checked = config.avoidSubdomains;

    updateDomainTags();
    updateSubdomainTooltip();
    hideStatus('processStatus');
  }

  /**
   * @description Rellena el tooltip de subdominios desde la configuracion cargada.
   */
  function updateSubdomainTooltip() {
    var list = document.getElementById('subdomainTooltipList');
    var title = document.getElementById('subdomainTooltipTitle');

    if (!config.ignoredSubdomains || !config.ignoredSubdomains.length) {
      title.textContent = 'Sin subdominios configurados';
      while (list.firstChild) list.removeChild(list.firstChild);
      return;
    }

    title.textContent = 'Subdominios ignorados (' + config.ignoredSubdomains.length + ')';
    while (list.firstChild) list.removeChild(list.firstChild);

    config.ignoredSubdomains.forEach(function(sub) {
      var span = document.createElement('span');
      span.textContent = sub;
      list.appendChild(span);
    });
  }

  function updateStatsUI(loadedStats) {
    if (!loadedStats) return;

    statsData = loadedStats;

    var elProcessed = document.getElementById('totalProcessed');
    var elLabeled = document.getElementById('totalLabeled');
    var elLastRun = document.getElementById('lastRun');

    elProcessed.textContent = statsData.totalProcessed || 0;
    elProcessed.classList.remove('loading');

    elLabeled.textContent = statsData.totalLabeled || 0;
    elLabeled.classList.remove('loading');

    if (statsData.lastRun) {
      elLastRun.textContent = new Date(statsData.lastRun).toLocaleString();
    } else {
      elLastRun.textContent = 'Nunca';
    }
    elLastRun.classList.remove('loading');

    updateDomainStats();
    generateChart();
  }

  /**
   * @description Construye un estado vacio con texto de guia usando DOM seguro.
   * @param {Element} container - Elemento contenedor
   * @param {string} mainText - Texto principal
   * @param {string} hintText - Texto secundario de guia
   */
  function renderEmptyState(container, mainText, hintText) {
    while (container.firstChild) container.removeChild(container.firstChild);

    var wrapper = document.createElement('div');
    wrapper.className = 'empty-state';

    var p = document.createElement('p');
    p.textContent = mainText;
    wrapper.appendChild(p);

    if (hintText) {
      var hint = document.createElement('p');
      hint.className = 'hint';
      hint.textContent = hintText;
      wrapper.appendChild(hint);
    }

    container.appendChild(wrapper);
  }

  function generateChart() {
    var chartContainer = document.getElementById('chartContainer');
    while (chartContainer.firstChild) chartContainer.removeChild(chartContainer.firstChild);

    var sortedDomains = Object.keys(statsData.domainStats || {}).sort(function(a, b) {
      return (statsData.domainStats[b] || 0) - (statsData.domainStats[a] || 0);
    });

    var topDomains = sortedDomains.slice(0, 5);

    if (topDomains.length === 0) {
      renderEmptyState(chartContainer, 'Sin datos de dominios todavia', 'Procesa correos para ver el grafico');
      return;
    }

    var maxValue = Math.max.apply(null, topDomains.map(function(d) {
      return statsData.domainStats[d];
    }));

    topDomains.forEach(function(domain) {
      var count = statsData.domainStats[domain] || 0;
      var percentage = (count / maxValue) * 100;

      var barContainer = document.createElement('div');
      barContainer.style.width = '100%';
      barContainer.style.marginBottom = '10px';

      var bar = document.createElement('div');
      bar.className = 'chart-bar';
      bar.style.width = Math.max(percentage, 20) + '%';

      var label = document.createElement('span');
      label.className = 'chart-bar-label';
      label.textContent = domain;

      var value = document.createElement('span');
      value.className = 'chart-bar-value';
      value.textContent = count;

      bar.appendChild(label);
      bar.appendChild(value);
      barContainer.appendChild(bar);
      chartContainer.appendChild(barContainer);
    });

    var legend = document.createElement('div');
    legend.className = 'chart-legend';

    var legendLeft = document.createElement('span');
    legendLeft.textContent = 'Dominios mas frecuentes';
    var legendRight = document.createElement('span');
    legendRight.textContent = 'Cantidad de correos';
    legend.appendChild(legendLeft);
    legend.appendChild(legendRight);

    chartContainer.appendChild(legend);
  }

  function updateDomainStats() {
    var container = document.getElementById('domainStats');
    while (container.firstChild) container.removeChild(container.firstChild);

    var sortedDomains = Object.keys(statsData.domainStats || {}).sort(function(a, b) {
      return (statsData.domainStats[b] || 0) - (statsData.domainStats[a] || 0);
    });

    var topDomains = sortedDomains.slice(0, 10);

    if (topDomains.length === 0) {
      renderEmptyState(container, 'Sin estadisticas disponibles', 'Ejecuta el procesamiento para empezar a recopilar datos');
      return;
    }

    topDomains.forEach(function(domain) {
      var count = statsData.domainStats[domain] || 0;

      var domainStat = document.createElement('div');
      domainStat.className = 'domain-stat';

      var domainName = document.createElement('div');
      domainName.className = 'domain-name';
      domainName.textContent = domain;

      var domainCount = document.createElement('div');
      domainCount.className = 'domain-count';
      domainCount.textContent = count;

      domainStat.appendChild(domainName);
      domainStat.appendChild(domainCount);
      container.appendChild(domainStat);
    });
  }

  // --- Gestion de etiquetas de dominio ---

  /**
   * @description Renderiza las etiquetas de dominios genericos con DOM seguro.
   */
  function updateDomainTags() {
    var container = document.getElementById('domainTags');
    while (container.firstChild) container.removeChild(container.firstChild);

    config.genericDomains.forEach(function(domain) {
      var tag = document.createElement('div');
      tag.className = 'tag';

      tag.appendChild(document.createTextNode(domain));

      var deleteBtn = document.createElement('span');
      deleteBtn.className = 'tag-delete';
      deleteBtn.textContent = '\u00D7';
      deleteBtn.addEventListener('click', function() {
        removeDomain(domain);
      });
      tag.appendChild(deleteBtn);

      container.appendChild(tag);
    });
  }

  function isValidDomain(domain) {
    if (!domain || domain.length > 253) return false;
    return /^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(domain);
  }

  function addDomain() {
    var input = document.getElementById('newDomain');
    var domain = input.value.trim().toLowerCase();

    if (!domain) {
      showStatus('saveStatus', 'Introduce un dominio', 'error');
      setTimeout(function() { hideStatus('saveStatus'); }, 2000);
      return;
    }

    if (!isValidDomain(domain)) {
      showStatus('saveStatus', 'El dominio no tiene un formato valido', 'error');
      setTimeout(function() { hideStatus('saveStatus'); }, 2000);
      return;
    }

    if (config.genericDomains.includes(domain)) {
      showStatus('saveStatus', 'El dominio ya esta en la lista', 'error');
      setTimeout(function() { hideStatus('saveStatus'); }, 2000);
      return;
    }

    config.genericDomains.push(domain);
    updateDomainTags();
    input.value = '';
    showStatus('saveStatus', 'Dominio anadido. Recuerda guardar la configuracion.', 'info');
    setTimeout(function() { hideStatus('saveStatus'); }, 2000);
  }

  function removeDomain(domain) {
    config.genericDomains = config.genericDomains.filter(function(d) { return d !== domain; });
    updateDomainTags();
  }

  // --- Acciones del usuario ---

  function validateConfigBeforeSave() {
    var errors = [];

    var maxEmails = parseInt(document.getElementById('maxEmails').value);
    if (isNaN(maxEmails) || maxEmails < 10 || maxEmails > 500) {
      errors.push('Maximo de correos debe estar entre 10 y 500');
    }

    var processHour = parseInt(document.getElementById('processHour').value);
    if (isNaN(processHour) || processHour < 0 || processHour > 23) {
      errors.push('Hora de procesamiento debe estar entre 0 y 23');
    }

    var daysBack = parseInt(document.getElementById('daysBack').value);
    if (isNaN(daysBack) || daysBack < -1 || daysBack > 365) {
      errors.push('Dias hacia atras debe estar entre -1 (todos) y 365');
    }

    return { valid: errors.length === 0, errors: errors };
  }

  function saveConfig() {
    var validation = validateConfigBeforeSave();
    if (!validation.valid) {
      showStatusSafe('saveStatus', [
        'Errores de validacion:',
        { tag: 'br' }
      ].concat(
        validation.errors.reduce(function(acc, err, i) {
          if (i > 0) acc.push({ tag: 'br' });
          acc.push(err);
          return acc;
        }, [])
      ), 'error');
      return;
    }

    config.maxEmails = parseInt(document.getElementById('maxEmails').value) || 100;
    config.daysBack = parseInt(document.getElementById('daysBack').value);
    config.autoProcess = document.getElementById('autoProcess').checked;
    config.processHour = parseInt(document.getElementById('processHour').value);
    config.avoidSubdomains = document.getElementById('avoidSubdomains').checked;

    if (config.maxEmails < 10) config.maxEmails = 10;
    if (config.maxEmails > 500) config.maxEmails = 500;

    var saveButton = document.getElementById('saveButton');
    saveButton.disabled = true;
    showStatus('saveStatus', 'Guardando configuracion...', 'info');

    google.script.run
      .withSuccessHandler(function(result) {
        saveButton.disabled = false;

        if (result && result.success) {
          var parts = ['Configuracion guardada correctamente'];
          if (config.autoProcess) {
            parts.push({ tag: 'br' });
            parts.push('Procesamiento automatico a las ' +
              String(config.processHour).padStart(2, '0') + ':00 diario');
          }
          showStatusSafe('saveStatus', parts, 'success');
          setTimeout(function() { hideStatus('saveStatus'); }, 3000);
        } else {
          var errorParts = ['Error al guardar:', { tag: 'br' }];
          if (result && result.errors) {
            result.errors.forEach(function(err, i) {
              if (i > 0) errorParts.push({ tag: 'br' });
              errorParts.push(err);
            });
          } else {
            errorParts.push('Error desconocido');
          }
          showStatusSafe('saveStatus', errorParts, 'error');
        }
      })
      .withFailureHandler(function(error) {
        saveButton.disabled = false;
        showStatus('saveStatus', 'Error: ' + (error.message || ''), 'error');
      })
      .saveConfig(config);
  }

  function processEmails() {
    showStatusSafe('processStatus', [
      { tag: 'spinner' },
      ' Procesando correos...'
    ], 'info');

    var processButton = document.getElementById('processButton');
    processButton.disabled = true;

    var startTime = Date.now();

    google.script.run
      .withSuccessHandler(function(stats) {
        processButton.disabled = false;

        var duration = ((Date.now() - startTime) / 1000).toFixed(1);

        if (stats.error) {
          showStatus('processStatus', 'Error al procesar correos: ' + stats.error, 'error');
          return;
        }

        var parts = [
          'Completado en ' + duration + 's',
          { tag: 'br' }, { tag: 'br' },
          'Procesados: ' + (stats.processed || 0) + ' correos',
          { tag: 'br' },
          'Etiquetados: ' + (stats.labeled || 0) + ' correos',
          { tag: 'br' }
        ];

        if (stats.errors && stats.errors > 0) {
          parts.push({ tag: 'span', text: 'Errores: ' + stats.errors, style: 'color: #f44336' });
          parts.push({ tag: 'br' });
        }

        if (stats.message) {
          parts.push({ tag: 'br' });
          parts.push({ tag: 'i', text: stats.message });
          parts.push({ tag: 'br' });
        }

        if (stats.domains && Object.keys(stats.domains).length > 0) {
          parts.push({ tag: 'br' });
          parts.push('Top dominios procesados:');
          parts.push({ tag: 'br' });

          var sortedDomains = Object.keys(stats.domains)
            .sort(function(a, b) { return stats.domains[b] - stats.domains[a]; })
            .slice(0, 5);

          sortedDomains.forEach(function(domain) {
            parts.push('- ' + domain + ': ' + stats.domains[domain] + ' correos');
            parts.push({ tag: 'br' });
          });
        }

        showStatusSafe('processStatus', parts, 'success');

        setTimeout(function() { loadStats(); }, 500);
      })
      .withFailureHandler(function(error) {
        processButton.disabled = false;
        showStatusSafe('processStatus', [
          'Error al procesar correos:',
          { tag: 'br' },
          (error.message || error.toString()),
          { tag: 'br' }, { tag: 'br' },
          'Revisa los logs de ejecucion.'
        ], 'error');
      })
      .processEmails();
  }

  function exportStats() {
    var exportButton = document.getElementById('exportButton');
    exportButton.disabled = true;

    google.script.run
      .withSuccessHandler(function(csvUrl) {
        exportButton.disabled = false;
        if (csvUrl) {
          window.open(csvUrl, '_blank');
          showStatus('statsStatus', 'CSV exportado correctamente', 'success');
          setTimeout(function() { hideStatus('statsStatus'); }, 3000);
        } else {
          showStatus('statsStatus', 'No hay estadisticas para exportar', 'error');
        }
      })
      .withFailureHandler(function(error) {
        exportButton.disabled = false;
        showStatus('statsStatus', 'Error: ' + (error.message || ''), 'error');
      })
      .exportStatsToCSV();
  }

  function clearStats() {
    if (!confirm('Quieres eliminar todas las estadisticas? Esta accion no se puede deshacer.')) {
      return;
    }

    var clearButton = document.getElementById('clearStatsButton');
    clearButton.disabled = true;

    google.script.run
      .withSuccessHandler(function(result) {
        clearButton.disabled = false;

        if (result) {
          showStatus('statsStatus', 'Estadisticas eliminadas correctamente', 'success');
          statsData = { totalProcessed: 0, totalLabeled: 0, domainStats: {}, lastRun: null };
          updateStatsUI(statsData);
          setTimeout(function() { hideStatus('statsStatus'); }, 3000);
        } else {
          showStatus('statsStatus', 'Error al eliminar estadisticas', 'error');
        }
      })
      .withFailureHandler(function(error) {
        clearButton.disabled = false;
        showStatus('statsStatus', 'Error: ' + (error.message || ''), 'error');
      })
      .clearStats();
  }

  function handleError(error) {
    console.error('Error:', error);
    showStatus('processStatus', 'Error: ' + (error.message || ''), 'error');
  }
</script>
